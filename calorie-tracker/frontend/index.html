<!doctype html>
<html>
  <head>
    <title>Calorie Tracker - Add Meal</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track your meals and calories with our easy-to-use food tracking application">
    <meta name="author" content="Calorie Tracker App">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Calorie Tracker - Add Meal">
    <meta property="og:description" content="Track your meals and calories with our easy-to-use food tracking application">
    <meta property="og:image" content="assets/favicon/apple-touch-icon.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Calorie Tracker - Add Meal">
    <meta name="twitter:description" content="Track your meals and calories with our easy-to-use food tracking application">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="assets/favicon/site.webmanifest">
    <link rel="shortcut icon" href="assets/favicon/favicon.ico">
  </head>
  <body>
    <div class="navbar">
      <div class="navbar-container">
        <button class="navbar-toggle">â˜°</button>
        <a href="index.html" class="navbar-brand">Calorie Tracker</a>
        <ul class="navbar-menu">
          <li class="navbar-item"><a href="index.html" class="navbar-link">Add Meal</a></li>
          <li class="navbar-item"><a href="history.html" class="navbar-link">History</a></li>
          <li class="navbar-item"><a href="metrics.html" class="navbar-link">Metrics</a></li>
          <li class="navbar-item navbar-user-menu-item">
            <div class="navbar-user-section">
              <span id="userName"></span>
              <button id="logoutBtn" class="btn btn-neutral btn-sm btn-outline">Logout</button>
            </div>
          </li>
        </ul>
        <div class="navbar-user-section navbar-user-desktop">
          <span id="userName"></span>
          <button id="logoutBtn" class="btn btn-neutral btn-sm btn-outline">Logout</button>
        </div>
      </div>
    </div>
    
    <div class="container">
      <div class="card">
        <h2>Add New Meal</h2>
        <p class="mb-3">Take a photo of your food and our AI will analyze its nutritional content.</p>
        
        <form id="mealForm">
          <div class="form-group">
            <label class="form-label">Upload Food Image:</label>
            <p class="helper-text mb-2">Take a photo of your food or choose from your gallery. We'll analyze it automatically.</p>
            
            <div class="photo-options">
              <div class="photo-option">
                <label for="image" class="photo-option-button camera-option">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                  </svg>
                  <span>ðŸ“· Take Photo</span>
                </label>
                <input type="file" id="image" name="image" accept="image/*" capture="environment" class="photo-input" required />
              </div>
              <div class="photo-option">
                <label for="gallery-image" class="photo-option-button gallery-option">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                  <span>ðŸ–¼ Choose from Gallery</span>
                </label>
                <input type="file" id="gallery-image" name="gallery-image" accept="image/*" class="photo-input" />
              </div>
            </div>
            
            <div id="imagePreviewContainer" class="image-preview-container mt-3" style="display: none;">
              <div class="image-preview-header">
                <h4>Selected Image</h4>
                <button type="button" id="clearImageBtn" class="btn btn-sm btn-neutral">Clear</button>
              </div>
              <div id="imagePreview" class="image-preview"></div>
            </div>
            
            <div id="uploadProgress" class="upload-progress mt-3" style="display: none;">
              <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
              </div>
              <div id="progressStatus" class="progress-status">Uploading... 0%</div>
            </div>
            
            <div id="uploadSuccess" class="upload-success mt-3" style="display: none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              <span>Upload successful!</span>
            </div>
          </div>
          
          <div class="form-group mt-4">
            <button type="submit" class="btn btn-primary btn-block" style="font-size: 1.1rem; padding: 0.9rem 1.5rem; font-weight: 600;">Analyze & Upload Meal</button>
          </div>
        </form>
        
        <p id="mealMessage" class="text-danger mt-2"></p>
      </div>
      
      <div id="analysisResult" class="card" style="display: none; animation: fade-in 0.5s ease-out;">
        <h3>AI Analysis Results</h3>
        
        <div class="mb-3">
          <div id="foodImagePreview" class="text-center mb-3">
            <!-- Image will be inserted here -->
          </div>
          <div id="analysisContent"></div>
        </div>
        
        <div id="nutritionEditor" class="mb-4">
          <h4>Nutritional Information</h4>
          <p class="mb-2">You can adjust these values if needed:</p>
          
          <div class="form-group">
            <label for="edit-calories" class="form-label">Calories:</label>
            <input type="number" id="edit-calories" class="form-control" min="0" />
            <div id="calories-bar" class="mt-1"></div>
          </div>
          
          <div class="nutrition-grid mt-3">
            <div class="form-group">
              <label for="edit-protein" class="form-label">Protein (g):</label>
              <input type="number" id="edit-protein" class="form-control" min="0" />
            </div>
            
            <div class="form-group">
              <label for="edit-fat" class="form-label">Fat (g):</label>
              <input type="number" id="edit-fat" class="form-control" min="0" />
            </div>
            
            <div class="form-group">
              <label for="edit-carbs" class="form-label">Carbs (g):</label>
              <input type="number" id="edit-carbs" class="form-control" min="0" />
            </div>
            
            <div class="form-group">
              <label for="edit-fiber" class="form-label">Fiber (g):</label>
              <input type="number" id="edit-fiber" class="form-control" min="0" />
            </div>
            
            <div class="form-group">
              <label for="edit-sugar" class="form-label">Sugar (g):</label>
              <input type="number" id="edit-sugar" class="form-control" min="0" />
            </div>
            
            <div class="form-group">
              <label for="edit-sodium" class="form-label">Sodium (mg):</label>
              <input type="number" id="edit-sodium" class="form-control" min="0" />
            </div>
          </div>
          
          <div class="form-group mt-3">
            <label for="edit-meal-type" class="form-label">Meal Type:</label>
            <select id="edit-meal-type" class="form-control">
              <option value="breakfast">Breakfast</option>
              <option value="lunch">Lunch</option>
              <option value="dinner">Dinner</option>
              <option value="snack">Snack</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="edit-consumed-at" class="form-label">Consumed At:</label>
            <input type="datetime-local" id="edit-consumed-at" class="form-control" />
          </div>
          
          <div class="form-group">
            <label for="edit-notes" class="form-label">Notes:</label>
            <textarea id="edit-notes" class="form-control" rows="2"></textarea>
          </div>
          
          <div class="form-group mt-3">
            <button id="saveChangesBtn" class="btn btn-primary">Save Changes</button>
            <button id="resetChangesBtn" class="btn btn-secondary">Reset</button>
          </div>
        </div>
        
        <div id="macroDistribution" class="mb-3">
          <h4>Macronutrient Distribution</h4>
          <div class="nutrition-grid">
            <div class="nutrition-card">
              <div id="protein-percentage" class="value">0%</div>
              <div class="label">Protein</div>
            </div>
            <div class="nutrition-card">
              <div id="fat-percentage" class="value">0%</div>
              <div class="label">Fat</div>
            </div>
            <div class="nutrition-card">
              <div id="carbs-percentage" class="value">0%</div>
              <div class="label">Carbs</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Recent Meals</h3>
        <div id="recentMeals">
          <p>Loading recent meals...</p>
        </div>
        <div class="text-center mt-3">
          <a href="history.html" class="btn btn-secondary">View All Meals</a>
        </div>
      </div>
    </div>
    
    <script src="common.js"></script>
    <script src="imageOptimizer.js"></script>
    <script src="charts.js"></script>
    <script src="app.js"></script>
    <script>
      // Initialize the page
      document.addEventListener('DOMContentLoaded', () => {
        if (!checkAuth()) return;
        
        // Initialize the form
        initMealForm();
        
        // Load recent meals
        loadRecentMeals();
      });
      
      // Initialize meal form
      function initMealForm() {
        const form = document.getElementById('mealForm');
        const analysisResult = document.getElementById('analysisResult');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const resetChangesBtn = document.getElementById('resetChangesBtn');
        const cameraInput = document.getElementById('image');
        const galleryInput = document.getElementById('gallery-image');
        
        // Store the original meal data
        let originalMealData = null;
        
        // Handle photo input selection
        cameraInput.addEventListener('change', function() {
          if (this.files.length > 0) {
            galleryInput.value = ''; // Clear the other input
          }
        });
        
        galleryInput.addEventListener('change', function() {
          if (this.files.length > 0) {
            cameraInput.value = ''; // Clear the other input
            handleImageSelection(this.files[0]); // Handle the selected image
            console.log("Gallery image selected:", this.files[0].name);
          }
        });
        
        // Handle image selection and preview
        function handleImageSelection(file) {
          if (!file) return;
          
          // Show image preview
          const imagePreviewContainer = document.getElementById('imagePreviewContainer');
          const imagePreview = document.getElementById('imagePreview');
          
          // Create optimized image preview using ImageOptimizer
          ImageOptimizer.createThumbnail(file)
            .then(thumbnailUrl => {
              imagePreview.innerHTML = `<img src="${thumbnailUrl}" alt="Selected food image">`;
              imagePreviewContainer.style.display = 'block';
            })
            .catch(error => {
              console.error('Error creating thumbnail:', error);
              // Fallback to original method if optimization fails
              const reader = new FileReader();
              reader.onload = function(e) {
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Selected food image">`;
                imagePreviewContainer.style.display = 'block';
              };
              reader.readAsDataURL(file);
            });
          
          // Clear the other input and ensure we're using the correct file
          if (file === cameraInput.files[0]) {
            galleryInput.value = '';
            console.log("Camera file selected for preview");
          } else {
            cameraInput.value = '';
            console.log("Gallery file selected for preview");
          }
        }
        
        // Handle camera input change
        cameraInput.addEventListener('change', function() {
          if (this.files.length > 0) {
            handleImageSelection(this.files[0]);
          }
        });
        
        // This duplicate event listener was causing issues - removed
        
        
        // Handle form submission
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const messageEl = document.getElementById('mealMessage');
          const uploadProgress = document.getElementById('uploadProgress');
          const progressBar = document.getElementById('progressBar');
          const progressStatus = document.getElementById('progressStatus');
          const uploadSuccess = document.getElementById('uploadSuccess');
          
          messageEl.textContent = '';
          analysisResult.style.display = 'none';
          uploadSuccess.style.display = 'none';
          
          // Check if an image was selected
          const cameraFile = cameraInput.files[0];
          const galleryFile = galleryInput.files[0];
          
          if (!cameraFile && !galleryFile) {
            messageEl.textContent = 'Please select an image or take a photo';
            messageEl.className = 'text-danger mt-2';
            return;
          }
          
          // Show loading message and progress bar
          messageEl.textContent = 'Analyzing your food image...';
          messageEl.className = 'text-info mt-2';
          uploadProgress.style.display = 'block';
          
          try {
            // Get the selected file - ensure we're using the correct file
            let selectedFile = null;
            if (cameraFile) {
              selectedFile = cameraFile;
              console.log("Using camera file for upload");
            } else if (galleryFile) {
              selectedFile = galleryFile;
              console.log("Using gallery file for upload");
            }
            
            if (!selectedFile) {
              throw new Error("No file selected");
            }
            
            // Create a FormData object for the API request
            const formData = new FormData();
            console.log("Selected file for upload:", selectedFile.name, "Size:", (selectedFile.size / 1024).toFixed(2) + "KB");
            
            // Check if the image should be optimized
            if (ImageOptimizer.shouldOptimize(selectedFile)) {
              try {
                // Show optimization status in progress message
                messageEl.textContent = 'Optimizing and analyzing your food image...';
                
                // Optimize the image before uploading
                const optimizedImage = await ImageOptimizer.optimizeImage(selectedFile);
                
                // Add the optimized image to the form data with the original filename
                formData.append('image', optimizedImage, selectedFile.name);
              } catch (optimizationError) {
                console.warn('Image optimization failed, using original image:', optimizationError);
                
                // Fallback to original image if optimization fails
                formData.append('image', selectedFile);
              }
            } else {
              // Use original image for small files
              formData.append('image', selectedFile);
            }
            
            // Simulate upload progress (since fetch doesn't support progress monitoring)
            let progress = 0;
            const progressInterval = setInterval(() => {
              progress += 5;
              if (progress > 90) {
                clearInterval(progressInterval);
                progress = 90; // Hold at 90% until complete
              }
              progressBar.style.width = `${progress}%`;
              progressStatus.textContent = `Uploading... ${progress}%`;
            }, 200);
            
            const response = await fetch(API.meals, {
              method: 'POST',
              headers: authHeaders(),
              body: formData
            });
            
            // Clear progress interval and set to 100%
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressStatus.textContent = 'Upload complete!';
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || 'Failed to upload meal');
            }
            
            const mealData = await response.json();
            originalMealData = { ...mealData };
            
            // Hide progress bar and show success message
            uploadProgress.style.display = 'none';
            uploadSuccess.style.display = 'flex';
            
            // Display success message
            messageEl.textContent = 'Meal analyzed successfully!';
            messageEl.className = 'text-success mt-2';
            
            // Show the analysis result
            displayAnalysisResult(mealData);
            
            // Reset the form and both inputs
            setTimeout(() => {
              form.reset();
              cameraInput.value = '';
              galleryInput.value = '';
              document.getElementById('imagePreviewContainer').style.display = 'none';
              uploadSuccess.style.display = 'none';
              console.log("Form reset after successful submission");
            }, 3000);
            
            // Load recent meals
            loadRecentMeals();
          } catch (error) {
            // Hide progress bar
            uploadProgress.style.display = 'none';
            
            messageEl.textContent = error.message;
            messageEl.className = 'text-danger mt-2';
            console.error('Error uploading meal:', error);
          }
        });
        
        // Handle save changes button
        saveChangesBtn.addEventListener('click', () => {
          // In a real implementation, this would send an update request to the API
          // For now, we'll just show a success message
          alert('Changes saved successfully!');
          
          // Update the original meal data with the edited values
          originalMealData.calories = parseInt(document.getElementById('edit-calories').value) || 0;
          originalMealData.protein = parseInt(document.getElementById('edit-protein').value) || 0;
          originalMealData.fat = parseInt(document.getElementById('edit-fat').value) || 0;
          originalMealData.carbs = parseInt(document.getElementById('edit-carbs').value) || 0;
          originalMealData.fiber = parseInt(document.getElementById('edit-fiber').value) || 0;
          originalMealData.sugar = parseInt(document.getElementById('edit-sugar').value) || 0;
          originalMealData.sodium = parseInt(document.getElementById('edit-sodium').value) || 0;
          originalMealData.meal_type = document.getElementById('edit-meal-type').value;
          
          // Convert local datetime to UTC for storage
          const localDateTime = document.getElementById('edit-consumed-at').value;
          originalMealData.consumed_at = localToUTC(new Date(localDateTime));
          
          originalMealData.notes = document.getElementById('edit-notes').value;
          
          // Update the display
          updateMacroDistribution();
        });
        
        // Handle reset changes button
        resetChangesBtn.addEventListener('click', () => {
          if (originalMealData) {
            // Reset the form fields to the original values
            document.getElementById('edit-calories').value = originalMealData.calories || 0;
            document.getElementById('edit-protein').value = originalMealData.protein || 0;
            document.getElementById('edit-fat').value = originalMealData.fat || 0;
            document.getElementById('edit-carbs').value = originalMealData.carbs || 0;
            document.getElementById('edit-fiber').value = originalMealData.fiber || 0;
            document.getElementById('edit-sugar').value = originalMealData.sugar || 0;
            document.getElementById('edit-sodium').value = originalMealData.sodium || 0;
            document.getElementById('edit-meal-type').value = originalMealData.meal_type;
            document.getElementById('edit-consumed-at').value = formatDateForInput(originalMealData.consumed_at);
            document.getElementById('edit-notes').value = originalMealData.notes || '';
            
            // Update the display
            updateMacroDistribution();
          }
        });
      }
      
      // Display analysis result
      function displayAnalysisResult(mealData) {
        const analysisResult = document.getElementById('analysisResult');
        const analysisContent = document.getElementById('analysisContent');
        const foodImagePreview = document.getElementById('foodImagePreview');
        
        // Extract food name from notes if available
        let foodName = mealData.meal_type.charAt(0).toUpperCase() + mealData.meal_type.slice(1);
        if (mealData.notes && mealData.notes.includes('AI Analysis:')) {
          const match = mealData.notes.match(/AI Analysis: (.+?)($|\n)/);
          if (match && match[1]) {
            foodName = match[1];
          }
        }
        
        // Display the food image
        foodImagePreview.innerHTML = `
          <img src="${mealData.image_url}" alt="${foodName}"
               class="food-thumbnail">
        `;
        
        // Display the analysis content
        analysisContent.innerHTML = `
          <h4>${foodName}</h4>
          <p><strong>Meal Type:</strong> ${mealData.meal_type.charAt(0).toUpperCase() + mealData.meal_type.slice(1)}</p>
          <p><strong>Time:</strong> ${formatDate(mealData.consumed_at)}</p>
        `;
        
        // Set the form values
        document.getElementById('edit-calories').value = mealData.calories || 0;
        document.getElementById('edit-protein').value = mealData.protein || 0;
        document.getElementById('edit-fat').value = mealData.fat || 0;
        document.getElementById('edit-carbs').value = mealData.carbs || 0;
        document.getElementById('edit-fiber').value = mealData.fiber || 0;
        document.getElementById('edit-sugar').value = mealData.sugar || 0;
        document.getElementById('edit-sodium').value = mealData.sodium || 0;
        document.getElementById('edit-meal-type').value = mealData.meal_type;
        document.getElementById('edit-consumed-at').value = formatDateForInput(mealData.consumed_at);
        document.getElementById('edit-notes').value = mealData.notes || '';
        
        // Create the calories progress bar
        const caloriesBar = document.getElementById('calories-bar');
        caloriesBar.innerHTML = createNutritionBar(mealData.calories, 2000);
        
        // Update macronutrient distribution
        updateMacroDistribution();
        
        // Show the analysis result
        analysisResult.style.display = 'block';
      }
      
      // Update macronutrient distribution
      function updateMacroDistribution() {
        const protein = parseInt(document.getElementById('edit-protein').value) || 0;
        const fat = parseInt(document.getElementById('edit-fat').value) || 0;
        const carbs = parseInt(document.getElementById('edit-carbs').value) || 0;
        
        // Convert to calories (protein: 4 cal/g, fat: 9 cal/g, carbs: 4 cal/g)
        const proteinCalories = protein * 4;
        const fatCalories = fat * 9;
        const carbCalories = carbs * 4;
        const totalCalories = proteinCalories + fatCalories + carbCalories;
        
        // Calculate percentages
        const proteinPercentage = totalCalories > 0 ? Math.round((proteinCalories / totalCalories) * 100) : 0;
        const fatPercentage = totalCalories > 0 ? Math.round((fatCalories / totalCalories) * 100) : 0;
        const carbsPercentage = totalCalories > 0 ? Math.round((carbCalories / totalCalories) * 100) : 0;
        
        // Update the display
        document.getElementById('protein-percentage').textContent = `${proteinPercentage}%`;
        document.getElementById('fat-percentage').textContent = `${fatPercentage}%`;
        document.getElementById('carbs-percentage').textContent = `${carbsPercentage}%`;
      }
      
      // Load recent meals
      async function loadRecentMeals() {
        const recentMealsEl = document.getElementById('recentMeals');
        
        try {
          const response = await fetch(`${API.meals}?limit=3`, {
            headers: authHeaders()
          });
          
          if (!response.ok) {
            if (response.status === 401) {
              logout();
              return;
            }
            throw new Error('Failed to load meals');
          }
          
          const meals = await response.json();
          
          if (meals.length === 0) {
            recentMealsEl.innerHTML = '<p>No meals found. Add your first meal above!</p>';
            return;
          }
          
          let html = '<div class="meal-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
          
          meals.forEach(meal => {
            // Extract food name from notes if available
            let foodName = meal.meal_type.charAt(0).toUpperCase() + meal.meal_type.slice(1);
            if (meal.notes && meal.notes.includes('AI Analysis:')) {
              const match = meal.notes.match(/AI Analysis: (.+?)($|\n)/);
              if (match && match[1]) {
                foodName = match[1];
              }
            }
            
            html += `
              <div class="meal-item">
                <img src="${meal.image_url}" alt="${meal.meal_type}" style="width: 100%; height: 150px; object-fit: cover;">
                <div class="meal-info p-2">
                  <h4>${foodName}</h4>
                  <p>${formatDate(meal.consumed_at)}</p>
                  <div class="calories-display">
                    <span class="calories-value">${meal.calories}</span>
                    <span class="calories-label">calories</span>
                  </div>
                  <div class="nutrition-bar-container" style="width: 100%; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; height: 6px; overflow: hidden; margin-top: 8px;">
                    <div style="width: ${Math.min(100, meal.calories / 20)}%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));"></div>
                  </div>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          recentMealsEl.innerHTML = html;
        } catch (error) {
          console.error('Error loading meals:', error);
          recentMealsEl.innerHTML = `<p class="text-danger">Error loading meals: ${error.message}</p>`;
        }
      }
    </script>
  </body>
</html>